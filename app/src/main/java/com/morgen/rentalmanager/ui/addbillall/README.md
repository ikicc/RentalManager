# 添加账单界面自定义表名称功能

## 功能概述

添加账单界面 (`AddBillAllScreen`) 已更新以支持在添加账单时直接编辑和设置额外水表和电表的自定义名称。该功能满足以下需求：

- **需求 4.1**: 当用户添加新的额外水表或电表时，允许设置自定义名称
- **需求 4.3**: 确保每个表的自定义名称独立管理
- **需求 4.5**: 为默认额外表提供合理的默认名称

## 实现特性

### 1. 表名称编辑功能
- 非主表（额外水表/电表）的名称可以直接在界面中编辑
- 主表（主水表/主电表）的名称不可编辑，保持固定
- 使用 `OutlinedTextField` 提供直观的编辑体验

### 2. 实时保存机制
- 用户修改表名称时，立即保存到数据库
- 使用 `MeterNameManager` 进行名称验证和存储
- 支持名称长度验证（1-20个字符）

### 3. 默认名称生成
- 新添加的额外表自动生成默认名称（如"额外水表1"、"额外电表1"）
- 如果已有自定义名称配置，则显示自定义名称
- 支持多个额外表的独立命名

### 4. 数据持久化
- 自定义名称保存到 `meter_name_configs` 表
- 使用原始名称（originalName）作为数据库存储的键
- 显示名称（name）用于界面展示

## 技术实现

### 数据模型更新
```kotlin
data class MeterInput(
    val id: String = UUID.randomUUID().toString(),
    val type: String, // "water" or "electricity"
    val name: String, // 显示名称（可能是自定义名称）
    val originalName: String = name, // 原始名称（用于数据库存储）
    val isPrimary: Boolean = false, // 是否为主表
    // ... 其他字段
)
```

### ViewModel 方法
```kotlin
fun onMeterNameChange(roomNumber: String, meterId: String, newName: String) {
    // 验证名称并保存到数据库
    // 更新UI状态
}
```

### UI 组件更新
```kotlin
@Composable
fun MeterInputItem(
    meter: MeterInput,
    // ... 其他参数
    onNameChange: ((String) -> Unit)? = null // 新增：表名称变更回调
) {
    // 根据是否为主表决定是否显示编辑框
    if (!meter.isPrimary && onNameChange != null) {
        OutlinedTextField(
            value = meter.name,
            onValueChange = onNameChange,
            label = { Text("表名称") }
        )
    } else {
        Text(meter.name) // 主表只显示名称
    }
}
```

## 用户体验

### 1. 直观的编辑界面
- 额外表的名称显示为可编辑的文本框
- 主表的名称显示为不可编辑的文本
- 清晰的视觉区分

### 2. 即时反馈
- 名称修改后立即保存
- 错误处理和日志记录
- 保持界面响应性

### 3. 一致性保证
- 修改的名称会在所有相关界面中同步显示
- 包括账单列表、账单详情、收据等

## 使用流程

1. **添加新表**: 用户点击"添加水表"或"添加电表"按钮
2. **自动命名**: 系统自动生成默认名称（如"额外水表1"）
3. **编辑名称**: 用户可以直接在名称文本框中修改名称
4. **实时保存**: 名称修改后自动保存到数据库
5. **全局生效**: 自定义名称在所有相关界面中生效

## 错误处理

- 名称验证失败时记录错误日志
- 数据库保存失败时不影响界面操作
- 降级到默认名称确保功能可用性

## 兼容性

- 向后兼容：现有的表名称不受影响
- 数据迁移：自动处理现有数据的名称映射
- 性能优化：只在需要时加载和保存自定义名称

## 测试建议

1. 测试添加新表时的默认名称生成
2. 测试表名称编辑和保存功能
3. 测试名称验证（长度、特殊字符等）
4. 测试主表名称不可编辑
5. 测试多个额外表的独立命名
6. 测试名称在其他界面的同步显示